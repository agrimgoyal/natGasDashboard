<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natural Gas Storage Analytics | v5.2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
        
        /* Loading Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i class="fa-solid fa-fire-flame-simple text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white">GasAnalytics <span class="text-blue-500">Pro</span></h1>
                    <p class="text-xs text-gray-400">Natural Gas Storage Dashboard</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="loading-indicator" class="hidden flex items-center gap-2 text-blue-400 text-sm">
                    <div class="loader"></div> Loading...
                </div>
                <div id="data-source-badge" class="hidden px-3 py-1 rounded-full bg-gray-700 border border-gray-600 text-xs text-gray-300">
                    <i class="fa-solid fa-database mr-1"></i> <span id="source-name">Default Data</span>
                </div>

                <label class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg border border-gray-600 transition flex items-center gap-2 text-sm shadow-sm group">
                    <i class="fa-solid fa-upload group-hover:text-blue-400 transition"></i>
                    <span>Upload New File</span>
                    <input type="file" id="file-input" class="hidden" accept=".xls,.xlsx">
                </label>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 space-y-6">

        <div id="empty-state" class="hidden flex flex-col items-center justify-center h-[60vh] text-center space-y-4">
            <div class="bg-gray-800 p-8 rounded-2xl border border-gray-700 shadow-xl max-w-md">
                <i class="fa-solid fa-chart-line text-6xl text-gray-600 mb-6"></i>
                <h2 class="text-2xl font-bold text-white mb-2">No Data Found</h2>
                <p class="text-gray-400 mb-6">Could not load default data. Please upload your EIA Excel file (<code class="bg-gray-900 px-2 py-1 rounded text-blue-400 text-sm">ngshistory.xls</code>).</p>
                <button onclick="document.getElementById('file-input').click()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-medium transition w-full shadow-lg shadow-blue-900/20">
                    Select File
                </button>
            </div>
        </div>

        <div id="dashboard-content" class="hidden space-y-6">
            
            <div class="flex overflow-x-auto pb-2 gap-2 scrollbar-hide" id="region-tabs"></div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-panel p-5 rounded-xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-cube text-6xl text-blue-500"></i>
                    </div>
                    <p class="text-sm text-gray-400 font-medium">Current Storage</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="kpi-storage">--</h3>
                    <div class="mt-2 text-xs flex items-center gap-2">
                        <span id="kpi-storage-badge" class="px-2 py-0.5 rounded bg-gray-700 text-gray-300">--</span>
                        <span class="text-gray-500">BCF</span>
                    </div>
                </div>
                <div class="glass-panel p-5 rounded-xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-arrow-right-arrow-left text-6xl text-purple-500"></i>
                    </div>
                    <p class="text-sm text-gray-400 font-medium">Weekly Net Flow</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="kpi-flow">--</h3>
                    <div class="mt-2 text-xs text-gray-400" id="kpi-flow-desc">Injection/Withdrawal</div>
                </div>
                <div class="glass-panel p-5 rounded-xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-scale-balanced text-6xl text-orange-500"></i>
                    </div>
                    <p class="text-sm text-gray-400 font-medium">vs 5-Year Avg</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="kpi-diff-avg">--</h3>
                    <div class="mt-2 w-full bg-gray-700 rounded-full h-1.5">
                        <div id="kpi-diff-bar" class="bg-orange-500 h-1.5 rounded-full" style="width: 50%"></div>
                    </div>
                </div>
                <div class="glass-panel p-5 rounded-xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-battery-half text-6xl text-green-500"></i>
                    </div>
                    <p class="text-sm text-gray-400 font-medium">Capacity Utilization</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="kpi-capacity">--%</h3>
                    <div class="mt-2 text-xs text-gray-500">
                        Based on <span id="kpi-cap-total">--</span> BCF Capacity
                    </div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-xl border-l-4 border-blue-500">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-calendar-week text-blue-400"></i> 
                            Upcoming Week Outlook
                        </h3>
                        <p class="text-sm text-gray-400 mt-1">
                            Projection based on Week #<span id="outlook-week-num" class="font-mono text-white">--</span> historicals
                            (Next Report: <span id="outlook-next-date" class="text-blue-300">--</span>)
                        </p>
                    </div>
                    <div class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700 text-center">
                        <p class="text-xs text-gray-400 uppercase tracking-wider">5-Year Avg Flow</p>
                        <p id="outlook-5yr-avg" class="text-xl font-bold text-white">--</p>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-800/50">
                            <tr>
                                <th class="px-4 py-3 rounded-l-lg">Year</th>
                                <th class="px-4 py-3">Report Date</th>
                                <th class="px-4 py-3 text-right">Net Flow (BCF)</th>
                                <th class="px-4 py-3 text-right">Storage Level (BCF)</th>
                                <th class="px-4 py-3 rounded-r-lg text-center">Type</th>
                            </tr>
                        </thead>
                        <tbody id="outlook-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass-panel p-5 rounded-xl lg:col-span-2 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-chart-area text-blue-500"></i> Storage Level Analysis
                        </h3>
                    </div>
                    <div id="chart-storage" class="w-full h-[400px]"></div>
                </div>
                <div class="glass-panel p-5 rounded-xl shadow-lg">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-bar text-purple-500"></i> Weekly Net Flows
                    </h3>
                    <div id="chart-flow" class="w-full h-[400px]"></div>
                </div>
            </div>

            <div class="glass-panel p-5 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-timeline text-green-500"></i> Seasonality (10-Year Spaghetti Plot)
                    </h3>
                    <div class="text-xs text-gray-400 bg-gray-800 px-3 py-1 rounded-full border border-gray-700">
                        Highlighting Current Year
                    </div>
                </div>
                <div id="chart-seasonality" class="w-full h-[450px]"></div>
            </div>
            
        </div>
    </main>

    <footer class="border-t border-gray-800 mt-12 py-6 bg-gray-900">
        <div class="max-w-7xl mx-auto px-6 text-center text-gray-500 text-sm">
            <p>&copy; 2026 Natural Gas Storage Analyzer. Runs in-browser.</p>
        </div>
    </footer>

    <script>
        // CONFIG
        const DEFAULT_FILE_URL = './ngshistory.xls'; // Assumes file is in same repo folder
        
        const REGION_CAPACITY = {
            'Total Lower 48': 4693, 'East': 863, 'Midwest': 1107, 'Mountain': 228,
            'Pacific': 397, 'South Central': 2098, 'Salt': 712, 'Non Salt': 1386
        };

        const REGION_MAPPING = {
            'Total Lower 48': ['total lower 48', 'lower 48'],
            'Salt': ['salt', 'south central salt'],
            'Non Salt': ['nonsalt', 'non-salt', 'south central nonsalt'],
            'East': ['east'], 'Midwest': ['midwest'], 'Mountain': ['mountain'],
            'Pacific': ['pacific'], 'South Central': ['south central']
        };

        const COLORS = {
            bg: '#111827', text: '#f3f4f6', grid: '#374151',
            blue: '#3b82f6', orange: '#f97316', green: '#22c55e', red: '#ef4444'
        };

        let GLOBAL_DATA = null;
        let ACTIVE_REGION = 'Total Lower 48';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', init);
        document.getElementById('file-input').addEventListener('change', handleFileUpload);

        async function init() {
            // Show loading
            document.getElementById('loading-indicator').classList.remove('hidden');
            
            try {
                const response = await fetch(DEFAULT_FILE_URL);
                if (!response.ok) throw new Error("Default file not found");
                
                const arrayBuffer = await response.arrayBuffer();
                loadWorkbook(arrayBuffer, "Default Data");
                
            } catch (err) {
                console.warn("Could not load default file:", err);
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('source-name').innerText = "Processing...";
            
            const reader = new FileReader();
            reader.onload = function(e) {
                loadWorkbook(new Uint8Array(e.target.result), file.name);
            };
            reader.readAsArrayBuffer(file);
        }

        function loadWorkbook(data, sourceName) {
            try {
                const workbook = XLSX.read(data, {type: 'array'});
                let targetSheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('hist')) || workbook.SheetNames[1] || workbook.SheetNames[0];
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[targetSheetName], {header: 1});

                processExcelData(jsonData);

                // UI Updates
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');
                document.getElementById('loading-indicator').classList.add('hidden');
                
                const badge = document.getElementById('data-source-badge');
                badge.classList.remove('hidden');
                document.getElementById('source-name').innerText = sourceName;
                
            } catch (err) {
                alert("Error processing file: " + err.message);
                console.error(err);
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        function processExcelData(rawRows) {
            let headerIdx = -1;
            for(let i=0; i<20; i++) {
                const rowStr = rawRows[i].map(c => String(c).toLowerCase()).join(' ');
                if(rowStr.includes('week ending') && rowStr.includes('total lower 48')) {
                    headerIdx = i;
                    break;
                }
            }
            if(headerIdx === -1) throw new Error("Could not find header row");

            const headers = rawRows[headerIdx].map(h => String(h).trim());
            const colMap = {};
            
            headers.forEach((h, idx) => {
                const hLow = h.toLowerCase();
                if(hLow.includes('week ending')) colMap['Date'] = idx;
                for(const [regionKey, keywords] of Object.entries(REGION_MAPPING)) {
                    if(regionKey === 'South Central' && hLow.includes('salt')) continue;
                    if(keywords.some(k => hLow.includes(k) || hLow === k)) if(!colMap[regionKey]) colMap[regionKey] = idx;
                }
            });

            const processedData = [];
            rawRows.slice(headerIdx + 1).forEach(row => {
                const dateVal = row[colMap['Date']];
                if(!dateVal) return;
                let dateObj = typeof dateVal === 'number' ? new Date(Math.round((dateVal - 25569)*86400*1000)) : new Date(dateVal);
                if(isNaN(dateObj.getTime())) return;

                const entry = { date: dateObj, year: dateObj.getFullYear(), weekNum: getWeekNumber(dateObj), regions: {} };
                for(const [rKey, colIdx] of Object.entries(colMap)) {
                    if(rKey === 'Date') continue;
                    const val = parseFloat(row[colIdx]);
                    entry.regions[rKey] = isNaN(val) ? null : val;
                }
                processedData.push(entry);
            });

            processedData.sort((a,b) => a.date - b.date);

            // Flows & Avgs
            const groupedByWeek = {};
            processedData.forEach(d => {
                if(!groupedByWeek[d.weekNum]) groupedByWeek[d.weekNum] = [];
                groupedByWeek[d.weekNum].push(d);
            });

            processedData.forEach((d, i) => {
                for(const rKey of Object.keys(d.regions)) {
                    // Flow
                    if(i > 0 && processedData[i-1].regions[rKey] != null && d.regions[rKey] != null) {
                        d[`${rKey}_flow`] = d.regions[rKey] - processedData[i-1].regions[rKey];
                    } else d[`${rKey}_flow`] = null;

                    // 5Yr Avg
                    const matches = groupedByWeek[d.weekNum] || [];
                    const pastVals = matches.filter(m => m.year >= d.year - 5 && m.year < d.year).map(m => m.regions[rKey]).filter(v => v != null);
                    
                    if(pastVals.length > 0) {
                        const avg = pastVals.reduce((a,b) => a+b, 0) / pastVals.length;
                        d[`${rKey}_5yr_avg`] = avg;
                        d[`${rKey}_diff_avg`] = (d.regions[rKey] - avg);
                    } else {
                        d[`${rKey}_5yr_avg`] = null;
                        d[`${rKey}_diff_avg`] = null;
                    }
                }
            });

            GLOBAL_DATA = processedData;
            generateTabs(Object.keys(REGION_MAPPING).filter(k => colMap[k] !== undefined));
            updateDashboard();
        }

        function generateTabs(availableRegions) {
            const container = document.getElementById('region-tabs');
            container.innerHTML = '';
            availableRegions.forEach(r => {
                const btn = document.createElement('button');
                btn.className = `whitespace-nowrap px-4 py-2 rounded-lg font-medium transition text-sm ${r === ACTIVE_REGION ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/40' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`;
                btn.innerText = r;
                btn.onclick = () => {
                    ACTIVE_REGION = r;
                    updateDashboard();
                    Array.from(container.children).forEach(c => {
                        c.className = c.innerText === r 
                            ? 'whitespace-nowrap px-4 py-2 rounded-lg font-medium transition text-sm bg-blue-600 text-white shadow-lg shadow-blue-900/40'
                            : 'whitespace-nowrap px-4 py-2 rounded-lg font-medium transition text-sm bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white';
                    });
                };
                container.appendChild(btn);
            });
        }

        function updateDashboard() {
            if(!GLOBAL_DATA) return;
            const rKey = ACTIVE_REGION;
            const currentData = GLOBAL_DATA[GLOBAL_DATA.length - 1];
            
            // KPIs
            const storage = currentData.regions[rKey];
            const flow = currentData[`${rKey}_flow`];
            const diffAvg = currentData[`${rKey}_diff_avg`];
            const capacity = REGION_CAPACITY[rKey] || 0;

            document.getElementById('kpi-storage').innerText = Math.round(storage).toLocaleString();
            document.getElementById('kpi-storage-badge').innerText = moment(currentData.date).format('MMM DD');
            
            const flowEl = document.getElementById('kpi-flow');
            flowEl.innerText = (flow > 0 ? '+' : '') + Math.round(flow);
            flowEl.className = `text-3xl font-bold mt-1 ${flow > 0 ? 'text-blue-400' : 'text-orange-400'}`;
            document.getElementById('kpi-flow-desc').innerText = flow > 0 ? 'Net Injection' : 'Net Withdrawal';

            const diffEl = document.getElementById('kpi-diff-avg');
            diffEl.innerText = (diffAvg > 0 ? '+' : '') + Math.round(diffAvg);
            diffEl.className = `text-3xl font-bold mt-1 ${diffAvg > 0 ? 'text-green-400' : 'text-red-400'}`;
            
            if(capacity > 0) {
                const pct = (storage / capacity) * 100;
                document.getElementById('kpi-capacity').innerText = pct.toFixed(1) + '%';
                document.getElementById('kpi-cap-total').innerText = capacity.toLocaleString();
            }

            // Charts
            renderStorageChart(rKey);
            renderFlowChart(rKey);
            renderSeasonalityChart(rKey);
            renderOutlookPanel(rKey, currentData.date);
        }

        function renderOutlookPanel(region, lastDate) {
            const nextDate = new Date(lastDate.getTime() + 7 * 24 * 60 * 60 * 1000);
            const nextWeekNum = getWeekNumber(nextDate);
            
            document.getElementById('outlook-week-num').innerText = nextWeekNum;
            document.getElementById('outlook-next-date').innerText = moment(nextDate).format('MMM DD, YYYY');

            const historicals = GLOBAL_DATA.filter(d => d.weekNum === nextWeekNum).sort((a,b) => b.year - a.year).slice(0, 5);
            const tbody = document.getElementById('outlook-table-body');
            tbody.innerHTML = '';

            let flowSum = 0;
            let count = 0;

            historicals.forEach(h => {
                const flow = h[`${region}_flow`];
                if(flow == null) return;
                flowSum += flow;
                count++;

                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-700 hover:bg-gray-800 transition';
                const flowColor = flow > 0 ? 'text-blue-400' : 'text-orange-400';
                const flowType = flow > 0 ? 'Inj' : (flow < 0 ? 'Wdr' : 'Flat');
                const badgeColor = flow > 0 ? 'bg-blue-900 text-blue-300' : (flow < 0 ? 'bg-orange-900 text-orange-300' : 'bg-gray-700');

                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-white">${h.year}</td>
                    <td class="px-4 py-3">${moment(h.date).format('MMM DD')}</td>
                    <td class="px-4 py-3 text-right font-bold ${flowColor}">${flow > 0 ? '+' : ''}${flow.toFixed(0)}</td>
                    <td class="px-4 py-3 text-right">${Math.round(h.regions[region]).toLocaleString()}</td>
                    <td class="px-4 py-3 text-center"><span class="text-xs px-2 py-1 rounded ${badgeColor}">${flowType}</span></td>
                `;
                tbody.appendChild(tr);
            });

            const avgFlow = count > 0 ? (flowSum / count) : 0;
            const avgEl = document.getElementById('outlook-5yr-avg');
            avgEl.innerText = (avgFlow > 0 ? '+' : '') + avgFlow.toFixed(1) + " BCF";
            avgEl.className = `text-xl font-bold ${avgFlow > 0 ? 'text-blue-400' : 'text-orange-400'}`;
        }

        function renderStorageChart(region) {
            const dates = GLOBAL_DATA.map(d => d.date);
            const storage = GLOBAL_DATA.map(d => d.regions[region]);
            const avg5yr = GLOBAL_DATA.map(d => d[`${region}_5yr_avg`]);
            const cutoff = new Date(); cutoff.setFullYear(cutoff.getFullYear() - 2);
            
            Plotly.newPlot('chart-storage', [
                { x: dates, y: storage, name: 'Current', line: { color: COLORS.blue, width: 3 }, type: 'scatter', fill: 'tozeroy', fillcolor: 'rgba(59, 130, 246, 0.1)' },
                { x: dates, y: avg5yr, name: '5Y Avg', line: { color: COLORS.orange, width: 2, dash: 'dash' }, type: 'scatter' }
            ], {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
                xaxis: { range: [cutoff, dates[dates.length-1]], gridcolor: COLORS.grid },
                yaxis: { gridcolor: COLORS.grid }, margin: { t: 10, l: 40, r: 10, b: 40 }, legend: { orientation: 'h', y: 1.1 }
            }, {responsive: true, displayModeBar: false});
        }

        function renderFlowChart(region) {
            const dataSlice = GLOBAL_DATA.slice(-52);
            const flows = dataSlice.map(d => d[`${region}_flow`]);
            Plotly.newPlot('chart-flow', [{
                x: dataSlice.map(d => d.date), y: flows, type: 'bar', marker: { color: flows.map(v => v >= 0 ? COLORS.blue : COLORS.orange) }
            }], {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
                xaxis: { gridcolor: COLORS.grid }, yaxis: { gridcolor: COLORS.grid }, margin: { t: 10, l: 40, r: 10, b: 40 }
            }, {responsive: true, displayModeBar: false});
        }

        function renderSeasonalityChart(region) {
            const years = [...new Set(GLOBAL_DATA.map(d => d.year))].sort().slice(-10);
            const traces = years.map((year, idx) => {
                const yearData = GLOBAL_DATA.filter(d => d.year === year);
                const isCurrent = idx === years.length - 1;
                return {
                    x: yearData.map(d => d.weekNum), y: yearData.map(d => d.regions[region]),
                    name: year.toString(), mode: 'lines',
                    line: { color: isCurrent ? COLORS.red : 'rgba(156, 163, 175, 0.4)', width: isCurrent ? 4 : 1 },
                    hoverinfo: 'y+name'
                };
            });
            Plotly.newPlot('chart-seasonality', traces, {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
                xaxis: { title: 'Week Number', gridcolor: COLORS.grid }, yaxis: { gridcolor: COLORS.grid },
                margin: { t: 10, l: 40, r: 10, b: 40 }, showlegend: false
            }, {responsive: true, displayModeBar: false});
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
    </script>
</body>
</html>
